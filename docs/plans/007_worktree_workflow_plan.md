# Deba システム仕様 - Git Worktree 統合による堅牢な実行環境

## 1. 概要

Deba は、メインの作業ディレクトリを一切汚さずに AI エージェントが自律的に作業を行うため、**Git Worktree** による隔離環境（Isolation）を採用しています。
これにより、ユーザーが VSCode 等でメインブランチを作業している最中でも、エージェントは裏側で別のブランチをチェックアウトし、コード修正やテスト実行を行うことが可能です。

---

## 2. ワークフローの詳細

### Step 1: 隔離実行の自動開始 (`deba run`)
ユーザーがタスクを依頼すると、Deba はプロジェクトルート内に一時的な Worktree を作成します。

```bash
$ deba run "リファクタリングして"

# 内部自動処理:
# 1. taskId (例: task_20260225_001) を生成
# 2. .worktrees/ ディレクトリをプロジェクトルートに作成
# 3. git worktree add .worktrees/deba-wt-task_20260225_001 -b feature/task_20260225_001
# 4. Worktree 内で Phase A (計画), Phase B (実装), テスト実行 を行う
# 5. スナップショットや実行ログは「本体」の snapshots/ に保存する
```

### Step 2: 隔離環境での自律作業
エージェント（AI）は、`.worktrees/deba-wt-xxx/` 内のファイルを対象に読み書きを行います。
- **メリット**: AI が誤ってファイルを全削除したり、無限ループするテストを走らせたりしても、メインディレクトリには一切影響を与えません。

### Step 3: レビューと取り込み (`deba review`)
作業完了後、ユーザーは `deba review` コマンドを使用して、隔離環境で行われた変更内容を確認・承認します。

```bash
$ deba review task_20260225_001
> 承認しますか？ [y/n/修正内容]: y

# 内部自動処理 (承認時):
# 1. git merge --squash feature/task_20260225_001 (本体に取り込み)
# 2. git worktree remove .worktrees/deba-wt-task_20260225_001 --force (クリーンアップ)
# 3. git branch -D feature/task_20260225_001 (ブランチ削除)
# 4. brain/episodes/ への記録と学びの抽出
```

---

## 3. 実装上の重要ポイント

### 3.1 本体ディレクトリパスの解決 (`getMainRepoRoot`)
Worktree 内で実行されている場合でも、`brain/` や `snapshots/` は常に「メインリポジトリ」側に保存される必要があります。
`src/utils/git.ts` の `getMainRepoRoot()` 関数により、Worktree 内部からでも確実にメインリポジトリのルートを特定し、知識ベースの一貫性を保っています。

### 3.2 セキュリティとクリーンアップ
- **`.gitignore`**: `.worktrees/` ディレクトリは Git 管理から除外されており、誤ってコミットされることはありません。
- **強制削除**: `deba maintenance clean` コマンドにより、放置された古い Worktree を一括で掃除することが可能です。

---

## 4. 期待される効果

1. **破壊的変更の防止**: AI の試行錯誤がメインディレクトリに影響を与えない。
2. **並列作業の実現**: ユーザーはメインディレクトリで別のブランチを作業し続けられる。
3. **クリーンな知識蓄積**: 作業場所を問わず、知見（スキル・エピソード）は常にメインリポジトリの `brain/` に集約される。
