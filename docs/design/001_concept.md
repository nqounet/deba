# システムアーキテクチャ: Deba - Portable Agent & Worktree Integration

## 1. システム全体像

Deba は、既存の Git リポジトリ内に「エージェント専用の作業領域（Worktree）」を自動構築し、そこで自律的に作業を行う「成長する新人エンジニア」型 AI エージェント CLI です。
グローバル設定に依存せず、プロジェクトルート内に知識（Brain）と作業領域（Worktrees）を保持する「ポータブル・エージェント」の思想に基づいています。

## 2. ディレクトリ構造とデータ管理

プロジェクトルート直下に以下のディレクトリを自動生成し、状態を管理します。

### 2.1 Project Brain (`brain/`)

エージェントの知識、経験、獲得したスキルが集約される場所です。

```text
brain/
├── ingestion.md              # プロジェクト全体の解析結果（技術スタック、ディレクトリ構造、主要ファイルの役割）
├── episodes/                 # タスクごとの実行記録（成功・失敗のコンテキスト）
├── skills/                   # 承認済みのスキル（コーディング規約・ベストプラクティス）
│   ├── proposals/            # 承認待ちのスキル提案
│   └── *_conventions.md      # プロジェクト別・言語別の規約ドキュメント
├── growth_log/               # 日々の学びの集約ログ
└── queue/                    # 非同期実行用のタスクキュー
```

### 2.2 Managed Worktrees (`.worktrees/`)

エージェントが隔離環境で作業するためのディレクトリ群です。`.gitignore` により Git 管理からは除外されます。

```text
.worktrees/
└── deba-wt-{task_id}/        # git worktree で一時的に作成される作業実体
    ├── .git                  # メインリポジトリを指す .git ファイル
    └── (Source Code)         # 特定のブランチがチェックアウトされたコード
```

### 2.3 Snapshots (`snapshots/`)

LLM とのやり取り（プロンプト全文、生レスポンス、パース結果、メタ情報）の全ての履歴です。

---

## 3. ワークフロー詳細

### A. Ingestion (プロジェクト取り込み)

初めてのリポジトリ作業時、または大規模な構成変更があった際、Deba は自動的に `ingestion` を実行します。

1. **スキャン**: プロジェクトのファイルツリー、`package.json`、`README.md` などを読み込みます。
2. **解析**: LLM を使用して、プロジェクトの目的、技術スタック、設計パターン、主要モジュールの依存関係を解析します。
3. **知識化**: 解析結果を `brain/ingestion.md` に保存します。このファイルは以降の全タスクで「プロジェクトの地図」としてプロンプトに注入されます。

### B. 隔離実行 (Git Worktree)

1. **Worktree作成**: `git worktree add -b feature/{task_id} .worktrees/deba-wt-{task_id}` を実行。
2. **自律作業**: エージェントは隔離された Worktree 内でコードを修正し、テストを実行します。
3. **マージ & クリーンアップ**: 作業完了後、`git merge --squash` により変更を本体に取り込み、Worktree を削除します。

### C. 自己成長サイクル

1. **Episode 記録**: タスク完了時に「何をしたか」「何が問題だったか」を `brain/episodes/` に保存。
2. **Review & Learning**: ユーザーによる `deba review` を通じて「学び」を抽出し、`growth_log` に記録。
3. **Consolidation**: `maintenance consolidate-skills` により、蓄積された学びを整理・統合し、`brain/skills/` の規約をリファクタリングします。

---

## 4. 技術的なキーポイント

### 1. ポータビリティと一貫性
知識（Brain）がプロジェクト内にあるため、開発者が変わったり、別のマシンで作業を再開したりしても、Deba はこれまでのコンテキスト（規約や過去の修正経緯）を維持したまま作業を継続できます。

### 2. `git worktree` による安全な自動化
メインの作業ディレクトリを一切汚さず、エージェントが裏側で「別デスク」で作業するような環境を提供します。これにより、ユーザーの作業を中断させることなく、並行してエージェントを動かすことが可能です。

### 3. コンテキストの動的注入
タスク実行時、`ingestion.md` (全体像)、`skills/` (規約)、`episodes/` (過去の成功/失敗) を動的に組み合わせてプロンプトを構築することで、LLM の精度を最大限に引き出します。
