## プロジェクト分析レポート: multi-agent-shogun

### 1. プロジェクトの目的

`multi-agent-shogun` は、複数のAIコーディングCLI (Claude Code, OpenAI Codex, GitHub Copilot, Kimi Code) を同時に実行し、封建時代の日本軍のように編成・統制するシステムです。ユーザー（「Lord」）が与えた命令を、Shogun（将軍）が受け取り、Karo（家老）を通じてAshigaru（足軽、ワーカー）とGunshi（軍師、ストラテジスト）にタスクを委任し、並列で実行させることを目的としています。これにより、AIによるコーディング作業の効率化と並列処理、および作業の透過性を高めます。

特徴的な機能として、以下のような目的も掲げられています。
- コーディネーションのオーバーヘッドなしで、8つのAIエージェントを並列実行。
- 次の命令をバックグラウンドで実行しながら、次の命令を与えられる非ブロッキングワークフロー。
- AIがセッション間で設定を記憶（Memory MCP）。
- ダッシュボードでのリアルタイムな進捗表示。
- 自然言語でのタスク指示と、スマートフォンからの操作（SayTask）。

### 2. アーキテクチャ

`multi-agent-shogun` は、tmux と YAML ファイルを基盤とした階層型のマルチエージェントシステムです。

- **階層構造:**
    - **Lord (人間)**: 最上位。Shogunに命令を与える。
    - **Shogun (将軍)**: Lordからの命令を受け取り、Karoに委任する司令官。自らタスクを実行しない。
    - **Karo (家老)**: Shogunから受け取ったタスクを分解し、AshigaruやGunshiに割り当てるマネージャー。品質チェック、ダッシュボード管理、タスク依存関係の解決も行う。
    - **Ashigaru (足軽)**: 1〜7人存在し、並列で具体的な実装タスク（コード作成、リサーチ、ビルド、ファイル操作など）を実行するワーカー。
    - **Gunshi (軍師)**: 1人存在し、分析、評価、設計レビュー、戦略策定などの高度なタスクを担当するストラテジスト。

- **実行環境:**
    - **tmuxセッション:** `shogun` セッション（LordとShogunが対話）、`multiagent` セッション（Karo、Ashigaru、Gunshiが並列実行）の2つのセッションが使用されます。各エージェントは独立したtmuxペインで動作します。
    - **WSL2 (Windows Subsystem for Linux):** Windows環境でのLinuxアプリケーション（tmuxなど）実行のために必要とされます。

- **通信メカニズム:**
    - **ファイルベースのメールボックスシステム:** エージェント間の通信は、ディスク上のYAMLファイルを通じて行われます（`queue/shogun_to_karo.yaml`, `queue/tasks/{agent_id}.yaml`, `queue/reports/{agent_id}_report.yaml`, `queue/inbox/{agent_id}.yaml`など）。
    - **イベント駆動型:** ポーリング（定期的な状態確認）は行わず、`inotifywait` (Linux) または `fswatch` (macOS) を使用してファイル変更を検知し、イベント駆動でエージェントを起動します。これにより、APIトークンの無駄遣いを防ぎます。
    - **`inbox_watcher.sh`:** 各エージェントのメールボックス（`queue/inbox/{agent_id}.yaml`）を監視し、新しいメッセージが到着した場合にtmux `send-keys` コマンドを使用してエージェントに「inboxN」（Nは未読メッセージ数）という短い通知を送ります。メッセージ本体はエージェント自身がファイルから読み込みます。
    - **エスカレーション:** エージェントが通知に応答しない場合、段階的なエスカレーション（通常nudge → Escape×2 + nudge → `/clear` または `/new` コマンドによるセッションリセット）が行われます。

- **コンテキスト管理:**
    - **4層アーキテクチャ:** Memory MCP (クロスセッション永続メモリ)、プロジェクトファイル (プロジェクト固有情報)、YAML キュー (権威あるタスクデータ)、セッションコンテキスト (一時的な作業用) で構成されます。

### 3. 技術スタック

- **言語:**
    - **Shell/Bash:** 主なスクリプト言語（`first_setup.sh`, `shutsujin_departure.sh`, `inbox_watcher.sh`, `scripts/`ディレクトリ内のユーティリティスクリプトなど）。
    - **Python:** YAMLファイルの読み書きや簡単なロジック（`inbox_watcher.sh` 内の Python スニペット）で利用。テスト依存関係の管理にもPythonのvenvが使用されます。
    - **YAML:** エージェント設定、通信メッセージ、タスク定義、レポートなどで広範に使用されます。
- **CLIツール:**
    - **Claude Code:** Anthropic社製のAIコーディングCLI。メインのAIエージェントとして利用されます。
    - **OpenAI Codex:** OpenAI製のAIコーディングCLI（gpt-5.3-codex, gpt-5.3-codex-sparkなど）。
    - **GitHub Copilot:** GitHub製のAIコーディングCLI。
    - **Kimi Code:** 無料枠が利用可能なAIコーディングCLI。
- **システムツール:**
    - **tmux:** ターミナルマルチプレクサ。複数のエージェントを独立したペインで並列実行するために必須です。
    - **Node.js v20+:** Memory MCPなどのMCPサーバーの実行に必要。
    - **ntfy:** オープンソースのプッシュ通知サービス。スマートフォンからのコマンド送信や通知受信に利用されます。
    - **inotify-tools (inotifywait):** Linux環境でのファイルシステム変更監視ツール。
    - **fswatch:** macOS環境でのファイルシステム変更監視ツール。
- **テストツール:**
    - **bats-core:** Bash用のテストフレームワーク。ユニットテストと結合テストに使用されます。
    - **shellcheck:** Shellスクリプトの静的解析ツール（リンター）。
- **その他:**
    - **Git:** バージョン管理。
    - **WSL2 (Windows Subsystem for Linux):** Windows環境でのLinux互換性レイヤー。
    - **Memory MCP:** Claude Codeの外部ツールとして、クロスセッションの長期記憶を提供。

### 4. 通信プロトコル

エージェント間の通信は、以下のプロトコルとメカニズムに基づいています。

- **ファイルベースのメールボックスシステム:**
    - `scripts/inbox_write.sh`: エージェントが他のエージェントにメッセージを送る際に使用。ターゲットエージェントの専用YAMLファイル (`queue/inbox/{agent_id}.yaml`) にメッセージを書き込みます。この際、ファイルの破損を防ぐために`flock`による排他ロックを使用します。
    - `inbox_watcher.sh`: 各エージェントのtmuxセッションでバックグラウンドで実行され、`inotifywait` または `fswatch` を使用して自身のメールボックスファイル (`queue/inbox/{agent_id}.yaml`) の変更を監視します。
- **起動シグナル（Nudge）:**
    - `tmux send-keys`: `inbox_watcher.sh` は、ファイル変更を検知すると、ターゲットエージェントのtmuxペインに「inboxN」という短い通知（ナッジ）を送信します。
- **エスカレーションメカニズム:** 応答がない場合は Escapeキー送信やセッションリセット（`/clear`）が行われ、エージェントにYAMLファイルを再読させます。

### 5. 特徴的な機能

- **並列実行:** Lordの1つの命令から、最大8体のAshigaruとGunshiが同時にタスクを実行します。
- **非ブロッキングワークフロー:** Shogunは命令を即座にKaroに委任し、Lordは次の命令を待たずに与えることができます。
- **クロスセッションメモリ (Memory MCP):** AIはLordの好みや過去の学習内容をセッションを超えて記憶します。
- **イベント駆動型通信 (ゼロポーリング):** `inotifywait`を利用したファイル変更検知により、低負荷かつリアルタイムな動作を実現。
- **電話通知 (ntfy):** ntfyアプリを利用して、スマートフォンからAI軍団に命令を与えたり、進捗通知を受け取ったりできます。
- **Bloom's Taxonomyに基づくタスクルーティング:** Karoはタスクを認知複雑性で分類し、最適なエージェントに割り当てます。
- **破壊的操作からの保護:** `AGENTS.md`に厳格なルールセットが定められており、システムへの破壊を防ぎます。
